import os
from snakemake.utils import Paramspace
import pandas as pd
#Settings steady state
Name = 'Budel' #puttenveld Budel, Schijf, Vlijmen
modelname ='fullrun'

Range = 4000 #m Distance from grid border to centre of wells 3200
GHBrange = 2000 
delr = 800
refineranges = {500:4}
startdate = '2014-12-31 00:00:00'         #eerste is '2014-12-31 00:00:00', '2018-06-01 00:00:00' is grensdatum droogte budel
enddate = '2018-06-01 00:00:00'         #laatste '2023-12-30 22:00:00'
drainC = 1

#Settings calibration
SensLayers = ['KIz2', 'KIk2','KIz3','KIk3','KIz4','KIz5']
CorLayers = {'KIz4' : 'KIz5'}
ghbCal = 'SensLayers' # 'obs', 'Single', None
KCal = True
Weighted = False
BadWells =['B57E0082_4', 'B57E0646_1', 'B57E0647_1','B57F0554_1'] #Budel

def get_paramspace(xcorlens,zcorlens,fracs):
    xl = []
    zl = []
    fl = []
    for x in xcorlens:
        for z in zcorlens:
            for f in fracs:
                xl.append(x)
                zl.append(z)
                fl.append(f)
    return pd.DataFrame({'xcorlens': xl,'zcorlens' : zl, 'fracs' : fl})

#Settings conditional simulation
simlayer = 'KIk2'
xcorlens = [200,500,1000, 2000]
zcorlens = [2.0,4.0,8.0]
fracs = [0,0.1,0.2]
ens_no = 50
dx = 25
df = get_paramspace(xcorlens,zcorlens, fracs)
paramspace = Paramspace(df)

rule all: 
    input:
        #expand(os.path.join('..' ,'Results',f'{modelname}','KfieldsQC', '{params}','k.csv'), params = paramspace.instance_patterns),
        # expand(os.path.join('..' ,'Results',f'{modelname}','KfieldsQC', '{params}','UpscaledK.nc'),params = paramspace.instance_patterns),
        expand(os.path.join('..' ,'Results',f'{modelname}','KfieldsQC', '{params}','RMSE.csv'),params = paramspace.instance_patterns),
        os.path.join('..' ,'Results',f'{modelname}','RMSE_all.csv')

rule Forward_Model_SS:
    input:
        'ForwardModelGen.py'
    output:
        os.path.join('..','Results',modelname, f'{modelname}_ss/{modelname}_ss.hds'),
        directory(os.path.join('..','Results',modelname, f'{modelname}_ss')),
        os.path.join('..','Results',f'{modelname}', f'{modelname}_SS',f'{modelname}_SS.nc'),
    params:
        Name = Name,
        modelname = modelname,
        Range = Range,
        GHBrange = GHBrange,
        delr = delr,
        refineranges = refineranges,
        steady_state = True,
        startdate = startdate,
        enddate = enddate,
        drainC = drainC
    script:
       'ForwardModelGen.py'
       
rule Forward_Model_T:
    input:
        'ForwardModelGen.py',
    output:
        os.path.join('..','Results',modelname, f'{modelname}_t/{modelname}_t.hds'),
        os.path.join('..','Results',f'{modelname}', f'{modelname}_t',f'{modelname}_t.nc'),
        os.path.join('..','Results',f'{modelname}',f'{modelname}_t', 'layer_model.nc'),
        directory(os.path.join('..','Results',modelname, f'{modelname}_t')),
    params:
        Name = Name ,
        modelname = modelname,
        Range = Range,
        GHBrange = GHBrange,
        delr = delr,
        refineranges = refineranges,
        steady_state = False,
        startdate = startdate,
        enddate = enddate,
        drainC = drainC 
    script:
       'ForwardModelGen.py'

rule Calibration_SS:
    input:
       os.path.join('..','Results',modelname, f'{modelname}_ss/{modelname}_ss.hds'),
       'Sensitivity.py'
    params:
        Name = Name,
        modelname = modelname,
        SensLayers = SensLayers,
        CorLayers = CorLayers,
        ghbCal = ghbCal,
        KCal = KCal,
        Weighted = Weighted,
        BadWells = BadWells,
    output:
       os.path.join('..','Results',f'{modelname}',f'ObsForCalibration_{modelname}_SS.csv'),
       os.path.join('..','Results',f'{modelname}',f'BestParams_SS_{modelname}.csv'),
        directory(os.path.join('..','Results',modelname, f'{modelname}_SS','Fitter')),
    script:
       'Sensitivity.py'

rule Calibration_T:
    input:
       'Calibration.py',
       os.path.join('..','Results',f'{modelname}',f'BestParams_SS_{modelname}.csv'),
       os.path.join('..','Results',modelname, f'{modelname}_t/{modelname}_t.hds')
    params:
        Name = Name,
        modelname = modelname,
        CorLayers = CorLayers,
    output:
        os.path.join('..','Results',f'{modelname}',f'BestParams_t_{modelname}.csv'),
        os.path.join('..','Results',f'{modelname}',f'ModHead_{modelname}.csv'),
    script:
       'Calibration.py'
       
rule Prep_Boreholes:
    input:
        'prep_boringen.py',
        os.path.join('..','Results',f'{modelname}',f'{modelname}_t', 'layer_model.nc')
    params:
        modelname = modelname,
        Name = Name,
        simlayer = simlayer
    output:
        os.path.join('..','Results',f'{modelname}','boreholeindicators.pkl')
    script:
        'prep_boringen.py'

rule Cond_Simulator:
    input:
       'condsim.py',
       os.path.join('..','Results',f'{modelname}', f'{modelname}_t',f'{modelname}_t.nc'),
       os.path.join('..','Results',f'{modelname}','boreholeindicators.pkl')
    params:
        Name = Name,
        modelname = modelname,
        simlayer = simlayer,
        simulation = paramspace.instance,
        ens_no = ens_no,
        dx = dx
    output:
        os.path.join('..' ,'Results',f'{modelname}','KfieldsQC', f'{paramspace.wildcard_pattern}','k.csv'),
    script:
       'condsim.py'

rule Upscaler:
    input:
       'Upscaler.py',
       os.path.join('..' ,'Results',f'{modelname}','KfieldsQC', f'{paramspace.wildcard_pattern}','k.csv'),
    params:
        Name = Name,
        modelname = modelname,
        simlayer = simlayer,
        ens_no = ens_no,
        dx = dx,
        ws = os.path.join('..' ,'Results',f'{modelname}','KfieldsQC', f'{paramspace.wildcard_pattern}','Upscaler')
    output:
        os.path.join('..' ,'Results',f'{modelname}','KfieldsQC', f'{paramspace.wildcard_pattern}','UpscaledK.nc'),
    script:
       'Upscaler.py'

rule Runner:
    input:
       'Runner.py',
       os.path.join('..' ,'Results',f'{modelname}','KfieldsQC', f'{paramspace.wildcard_pattern}','UpscaledK.nc'),
       os.path.join('..','Results',f'{modelname}',f'BestParams_t_{modelname}.csv'),
       os.path.join('..','Results',modelname, f'{modelname}_t','Fitter',f'{modelname}_t.nam')
    params:
        modelname = modelname,
        simlayer = simlayer,
        ens_no = ens_no,
    output:
        os.path.join('..' ,'Results',f'{modelname}','KfieldsQC', f'{paramspace.wildcard_pattern}','RMSE.csv'),
    script:
       'Runner.py'

rule Collector:
    input:
        expand(os.path.join('..' ,'Results',f'{modelname}','KfieldsQC', '{params}','RMSE.csv'), params = paramspace.instance_patterns),
        'collect.py'
    params:
        simulation = paramspace.instance,
    resources:
        n = 1 
    output:
        os.path.join('..' ,'Results',f'{modelname}','RMSE_all.csv'),
    script:
        'collect.py'
